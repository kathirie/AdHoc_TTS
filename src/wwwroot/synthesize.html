<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Speech Synthesizer Test</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 40px;
            max-width: 900px;
        }

        h1, h2 {
            margin-top: 0;
        }

        section {
            border: 1px solid #ccc;
            padding: 16px;
            margin-bottom: 24px;
            border-radius: 8px;
        }

        label {
            font-weight: 600;
            display: block;
            margin-top: 12px;
        }

        select, input, button, textarea {
            width: 100%;
            margin-top: 6px;
            padding: 6px;
            box-sizing: border-box;
        }

        textarea {
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        audio {
            margin-top: 20px;
            width: 100%;
        }

        small {
            color: #666;
        }

        .placeholder-field {
            margin-top: 12px;
            padding: 8px;
            border-left: 3px solid #999;
            background: #f7f7f7;
        }
    </style>
</head>
<body>

    <h1>Speech Synthesizer Test</h1>

    <!-- 1. TTS Model -->
    <section>
        <h2>1. TTS Model</h2>
        <label for="modelSelect">Select Model:</label>
        <select id="modelSelect"></select>
    </section>

    <!-- 2. SSML File Synth -->
    <section>
        <h2>2. Synthesize from SSML File</h2>

        <label for="ssmlFile">Select SSML File:</label>
        <input type="file" id="ssmlFile" accept=".xml,.ssml" />

        <button id="synthesizeFileBtn">Synthesize from File</button>
    </section>

    <!-- 3. Template Synth -->
    <section>
        <h2>3. Synthesize from Template</h2>

        <label for="templateSelect">Template:</label>
        <select id="templateSelect">
            <option value="">-- select a template --</option>
        </select>

        <label for="templateDescription">Description:</label>
        <textarea id="templateDescription" rows="3" readonly></textarea>

        <hr />

        <h3>Required Placeholder Values</h3>
        <p><small>Fields are generated dynamically based on the placeholders in the template SSML.</small></p>

        <div id="placeholderContainer"></div>

        <button id="synthesizeTemplateBtn">Synthesize from Template</button>
    </section>

    <!-- 4. Result -->
    <section>
        <h2>4. Result</h2>
        <audio id="audioPlayer" controls></audio>
    </section>

    <script>
        const baseUrl = "https://localhost:7275/api";

        const modelSelect = document.getElementById("modelSelect");
        const ssmlFile = document.getElementById("ssmlFile");
        const synthesizeFileBtn = document.getElementById("synthesizeFileBtn");
        const synthesizeTemplateBtn = document.getElementById("synthesizeTemplateBtn");
        const audioPlayer = document.getElementById("audioPlayer");

        const templateSelect = document.getElementById("templateSelect");
        const templateDescription = document.getElementById("templateDescription");
        const placeholderContainer = document.getElementById("placeholderContainer");

        // Lookup-Daten
        let locationNames = [];
        let platformNames = [];
        let routeNumbers = [];
        let frontTexts = [];

        // Placeholder-Erkennung im SSML
        const placeholderRegex = /\{([^}]+)\}/g;

        // Konfiguration, wie welcher Placeholder-Typ im UI dargestellt wird
        const placeholderConfig = {
            "Location.RefLocationName": {
                label: "Location (RefLocationName)",
                type: "select",
                source: "locations"
            },
            "Platform.PlatformNr": {
                label: "Platform (PlatformNr)",
                type: "select",
                source: "platforms"
            },
            "Route.RouteNr": {
                label: "Route (RouteNr)",
                type: "select",
                source: "routes"
            },
            "TargetText.FrontText": {
                label: "FrontText (TargetText.FrontText)",
                type: "select",
                source: "frontTexts"
            },
            "Freitext": {
                label: "Free Text (Freitext)",
                type: "textarea"
            }
        };

        function getOptionsForSource(source) {
            switch (source) {
                case "locations": return locationNames;
                case "platforms": return platformNames;
                case "routes": return routeNumbers;
                case "frontTexts": return frontTexts;
                default: return [];
            }
        }

        function parsePlaceholderOccurrences(ssmlContent) {
            const counts = {};
            let match;
            while ((match = placeholderRegex.exec(ssmlContent)) !== null) {
                const name = match[1];
                counts[name] = (counts[name] || 0) + 1;
            }
            return counts; // z.B. { "Location.RefLocationName": 2, "Platform.PlatformNr": 2 }
        }

        function buildPlaceholderUI(ssmlContent) {
            placeholderContainer.innerHTML = "";

            if (!ssmlContent) return;

            const occurrences = parsePlaceholderOccurrences(ssmlContent);

            Object.entries(occurrences).forEach(([name, count]) => {
                const cfg = placeholderConfig[name];
                if (!cfg) {
                    // Unbekannter Placeholder – fürs UI ignorieren
                    return;
                }

                for (let i = 0; i < count; i++) {
                    const wrapper = document.createElement("div");
                    wrapper.className = "placeholder-field";

                    const label = document.createElement("label");
                    const suffix = (count > 1) ? ` #${i + 1}` : "";
                    label.textContent = `${cfg.label}${suffix}:`;
                    wrapper.appendChild(label);

                    let input;

                    if (cfg.type === "select") {
                        input = document.createElement("select");
                        const options = getOptionsForSource(cfg.source);
                        options.forEach(val => {
                            const opt = document.createElement("option");
                            opt.value = val;
                            opt.textContent = val;
                            input.appendChild(opt);
                        });
                    } else if (cfg.type === "textarea") {
                        input = document.createElement("textarea");
                        input.rows = 2;
                    } else {
                        input = document.createElement("input");
                        input.type = "text";
                    }

                    input.classList.add("placeholder-input");
                    input.dataset.placeholder = name;
                    input.dataset.index = String(i);

                    wrapper.appendChild(input);
                    placeholderContainer.appendChild(wrapper);
                }
            });
        }

        // ---------- TTS Models laden ----------
        async function loadModels() {
            const res = await fetch(`${baseUrl}/TtsModels`);
            if (!res.ok) {
                alert("Failed to load TTS models.");
                return;
            }
            const models = await res.json();
            modelSelect.innerHTML =
                "<option value=''>-- select a model --</option>" +
                models.map(m =>
                    `<option value="${m.modelId}" data-provider="${m.provider}">
                        ${m.name} (${m.provider})
                     </option>`
                ).join("");
        }

        // ---------- Lookups laden ----------
        async function loadTemplates() {
            const res = await fetch(`${baseUrl}/messagetemplates`);
            if (!res.ok) {
                alert("Failed to load message templates.");
                return;
            }
            const templates = await res.json();
            templateSelect.innerHTML =
                "<option value=''>-- select a template --</option>" +
                templates.map(t => `<option value="${t.templateId}">${t.name}</option>`).join("");
        }

        async function loadLocations() {
            const res = await fetch(`${baseUrl}/Location/RefLocationNames`);
            if (!res.ok) {
                alert("Failed to load locations.");
                return;
            }
            locationNames = await res.json();
        }

        async function loadPlatforms() {
            const res = await fetch(`${baseUrl}/Platform/names`);
            if (!res.ok) {
                alert("Failed to load platforms.");
                return;
            }
            platformNames = await res.json();
        }

        async function loadRoutes() {
            const res = await fetch(`${baseUrl}/Route/RouteNrs`);
            if (!res.ok) {
                alert("Failed to load routes.");
                return;
            }
            routeNumbers = await res.json();
        }

        async function loadFrontTexts() {
            const res = await fetch(`${baseUrl}/TargetText/fronttexts`);
            if (!res.ok) {
                alert("Failed to load front texts.");
                return;
            }
            frontTexts = await res.json();
        }

        async function loadLookups() {
            await Promise.all([
                loadTemplates(),
                loadLocations(),
                loadPlatforms(),
                loadRoutes(),
                loadFrontTexts()
            ]);
        }

        // ---------- Template-Change ----------
        templateSelect.addEventListener("change", async () => {
            placeholderContainer.innerHTML = "";
            templateDescription.value = "";

            const templateId = templateSelect.value;
            if (!templateId) {
                return;
            }

            const res = await fetch(`${baseUrl}/messagetemplates/${templateId}`);
            if (!res.ok) {
                alert("Failed to load template details.");
                return;
            }

            const t = await res.json();
            templateDescription.value = t.description || "";
            const ssmlContent = t.ssmlContent || "";

            buildPlaceholderUI(ssmlContent);
        });

        // ---------- Synthesize from SSML file ----------
        synthesizeFileBtn.addEventListener("click", async () => {
            const modelId = modelSelect.value;
            const file = ssmlFile.files[0];

            if (!file || !modelId) {
                alert("Please select a model and a SSML file.");
                return;
            }

            const ssmlContent = await file.text();

            const reqBody = {
                ssmlContent,
                modelId,
                voiceId: null
            };

            const res = await fetch(`${baseUrl}/synthesis/from-ssml`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(reqBody)
            });

            if (!res.ok) {
                let msg = res.statusText;
                try {
                    const err = await res.json();
                    msg = err.error || JSON.stringify(err);
                } catch { }
                alert("Error: " + msg);
                return;
            }

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            audioPlayer.src = url;
            audioPlayer.play();
        });

        // ---------- Synthesize from Template ----------
        synthesizeTemplateBtn.addEventListener("click", async () => {
            const modelId = modelSelect.value;
            const templateId = templateSelect.value;

            if (!templateId) {
                alert("Please select a template.");
                return;
            }
            if (!modelId) {
                alert("Please select a model.");
                return;
            }

            // Alle Placeholder-Felder einsammeln
            const inputs = placeholderContainer.querySelectorAll(".placeholder-input");
            const map = {}; // placeholderName → array of values in occurrence order

            inputs.forEach(input => {
                const name = input.dataset.placeholder;  // z.B. "Location.RefLocationName"
                const idx = Number(input.dataset.index); // 0,1,2,...

                if (!map[name]) {
                    map[name] = [];
                }

                // Immer einen Eintrag setzen – leere Strings zählen als "ersetzt durch ''"
                map[name][idx] = input.value ?? "";
            });

            // Request-Body entsprechend deiner DTO-Namen
            const reqBody = {
                templateId,
                modelId,
                voiceId: null,
                refLocationNames: map["Location.RefLocationName"] || [],
                platformNrs: (map["Platform.PlatformNr"] || []).map(v => v === "" ? 0 : Number(v)),
                routeNrs: (map["Route.RouteNr"] || []).map(v => v === "" ? 0 : Number(v)),
                frontTexts: map["TargetText.FrontText"] || [],
                freeTexts: map["Freitext"] || []
            };

            console.log("from-template request body:", reqBody);

            const res = await fetch(`${baseUrl}/synthesis/from-template`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(reqBody)
            });

            if (!res.ok) {
                let msg = res.statusText;
                try {
                    const err = await res.json();
                    msg = err.error || JSON.stringify(err);
                } catch { }
                alert("Error: " + msg);
                return;
            }

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            audioPlayer.src = url;
            audioPlayer.play();
        });

        // ---------- Init ----------
        (async () => {
            await loadModels();
            await loadLookups();
        })();
    </script>

</body>
</html>
